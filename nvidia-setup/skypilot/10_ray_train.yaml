# 10_ray_train.yaml
resources:
  infra: k8s/default
  accelerators: RTX4060:1
  cpus: 4
  memory: 16+

setup: |
  pip install "ray[train]" torch torchvision tqdm

run: |
  python -c "
  import ray
  from ray import train
  from ray.train import ScalingConfig
  from ray.train.torch import TorchTrainer
  import torch

  def train_func():
      model = torch.nn.Linear(10, 1).cuda()
      optimizer = torch.optim.SGD(model.parameters(), lr=0.01)
      for epoch in range(5):
          x = torch.randn(32, 10).cuda()
          y = torch.randn(32, 1).cuda()
          loss = torch.nn.functional.mse_loss(model(x), y)
          optimizer.zero_grad(); loss.backward(); optimizer.step()
          print(f'Epoch {epoch}, Loss: {loss.item():.4f}')

  ray.init()
  trainer = TorchTrainer(train_func, scaling_config=ScalingConfig(num_workers=1, use_gpu=True))
  trainer.fit()
  "

